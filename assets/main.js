(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const p of o.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&i(p)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();let O,P,b,y,f,ae,oe,K,w,r,W,v,U,I,m,u,R,X,g,S,A=null,T=[],_="document";const me="^\\s*(第\\s*\\d+\\s*章[^\\r\\n]*?)\\s*$",le="Default (第X章)",ce="^\\s*(第\\s*[一二三四五六七八九十百千万]+\\s*章[^\\r\\n]*?)\\s*$",ie="Default (Chinese Numerals 第X章)";let l=[],Z=me;const pe="epubSplitterRegexTemplates",q="epubSplitterSelectedTemplateName";function xe(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function re(e,t=60){let n=e.replace(/[<>:"/\\|?*\x00-\x1F]/g,"_");return n=n.replace(/[\s_]+/g,"_"),n=n.replace(/^_+|_+$/g,""),n=n||"chapter",n.substring(0,t)}function Y(e){return e.replace(/[<>&'""]/g,function(t){switch(t){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case'"':return"&quot;"}return t})}function c(e,t="info"){y&&(y.textContent=e,y.className="",t&&y.classList.add(t),e?(y.style.display="block",y.setAttribute("aria-live",t==="error"?"assertive":"polite")):y.style.display="none")}function Q(e){K&&K.setAttribute("aria-busy",String(e)),b&&(b.disabled=e),O&&(O.disabled=e),w&&(w.disabled=e),g&&(g.disabled=e);const t=S==null?void 0:S.classList.contains("open");r&&(r.disabled=e&&t),v&&(v.disabled=e&&t),U&&(U.disabled=e&&t),I&&I.style.display!=="none"&&(m&&(m.disabled=e),u&&(u.disabled=e),R&&(R.disabled=e),X&&(X.disabled=e)),e&&(c("Processing EPUB... This may take a moment.","processing"),f&&(f.style.display="none"))}function Ee(e,t){const i=(e.includes("/")?e.substring(0,e.lastIndexOf("/")+1):"").split("/").filter(o=>o.length>0),a=t.split("/");for(const o of a)o===".."?i.length>0&&i.pop():o!=="."&&o!==""&&i.push(o);return i.join("/")}function ye(){const e=localStorage.getItem(pe);if(e)try{l=JSON.parse(e)}catch(a){console.error("Error parsing stored regex templates:",a),l=[]}else l=[];let t=!1;if(l.some(a=>a.name===le&&a.isDefault)||(l=l.filter(a=>a.name!==le),l.unshift({name:le,pattern:me,isDefault:!0}),t=!0),!l.some(a=>a.name===ie)){const a=l.findIndex(o=>o.isDefault);a!==-1&&a<l.length-1?l.splice(a+1,0,{name:ie,pattern:ce,isDefault:!1}):l.push({name:ie,pattern:ce,isDefault:!1}),t=!0}t&&fe()}function fe(){localStorage.setItem(pe,JSON.stringify(l))}function ue(){if(!r)return;r.innerHTML="",l.forEach(n=>{const i=document.createElement("option");i.value=n.name,i.textContent=n.name,n.isDefault,r.appendChild(i)});const e=localStorage.getItem(q),t=l.find(n=>n.name===e)||l.find(n=>n.isDefault);t?r.value=t.name:l.length>0&&(r.value=l[0].name),H()}function Te(){W&&(W.textContent=Z)}function H(){if(!r)return;const e=r.value,t=l.find(n=>n.name===e);if(t)Z=t.pattern,localStorage.setItem(q,t.name);else{const n=l.find(i=>i.isDefault);n?(Z=n.pattern,localStorage.setItem(q,n.name),r&&(r.value=n.name)):l.length>0&&(Z=l[0].pattern,localStorage.setItem(q,l[0].name),r&&(r.value=l[0].name))}Te()}function be(){I&&m&&u&&(m.value="",u.value="",I.style.display="block",m.focus(),v&&(v.style.display="none"),g&&S&&g.getAttribute("aria-expanded")==="false"&&ge())}function se(){I&&(I.style.display="none",v&&(v.style.display="inline-block"))}function we(){if(!m||!u)return;const e=m.value.trim(),t=u.value.trim();if(!e){c("Template name cannot be empty.","error"),m.focus();return}if(!t){c("Template pattern cannot be empty.","error"),u.focus();return}if(l.some(n=>n.name===e)){c(`A template with the name "${e}" already exists.`,"error"),m.focus();return}try{new RegExp(t)}catch(n){c(`Invalid regex pattern: ${n.message}`,"error"),u.focus();return}l.push({name:e,pattern:t,isDefault:!1}),fe(),ue(),r.value=e,H(),se(),c(`Template "${e}" saved successfully.`,"success")}function ve(){const e=l.find(t=>t.isDefault);e&&r?(r.value=e.name,H(),c("Regex pattern reset to default.","info")):l.length>0&&r&&(r.value=l[0].name,H(),c("Regex pattern reset to the first available template.","info"))}function ge(){if(!g||!S)return;const e=g.getAttribute("aria-expanded")==="true";g.setAttribute("aria-expanded",String(!e)),S.classList.toggle("open",!e),e&&I.style.display==="block"&&se()}async function Ie(e){var D,ee,te;const t=await JSZip.loadAsync(e),n=t.file("META-INF/container.xml");if(!n)throw new Error("META-INF/container.xml not found in EPUB.");const i=await n.async("string"),a=new DOMParser,p=(D=a.parseFromString(i,"application/xml").getElementsByTagName("rootfile")[0])==null?void 0:D.getAttribute("full-path");if(!p)throw new Error("Could not find rootfile path in container.xml.");const V=t.file(p);if(!V)throw new Error(`.opf file (${p}) not found.`);const k=await V.async("string"),M=a.parseFromString(k,"application/xml"),J=new Map,L=M.getElementsByTagName("item");for(let s=0;s<L.length;s++){const E=L[s].getAttribute("id"),C=L[s].getAttribute("href");E&&C&&J.set(E,C)}let h="";const d=M.getElementsByTagName("itemref");for(let s=0;s<d.length;s++){const E=d[s].getAttribute("idref");if(E){const C=J.get(E);if(C){const ne=Ee(p,C),j=t.file(ne);if(j){const G=await j.async("string"),$=a.parseFromString(G,"application/xhtml+xml");if($.getElementsByTagName("parsererror").length>0){const he=a.parseFromString(G,"text/html");h+=((ee=he.body)==null?void 0:ee.textContent)||""}else h+=((te=$.body)==null?void 0:te.textContent)||"";h+=`

`}}}}const x=[];let F;try{F=new RegExp(Z,"gm")}catch(s){throw new Error(`Invalid Regex Pattern in selected template: ${s.message}. Please check Advanced Options.`)}let N;const B=[];for(;(N=F.exec(h))!==null;){const s=(N[1]||N[0]).trim();B.push({title:s,index:N.index,rawMatch:N[0]})}if(B.length===0)return x.push({title:"Full Document (No Chapter Markers Detected)",content:h.trim(),xhtmlFileName:"chapter_1.xhtml",ncxNavPointId:"navpoint_1",opfItemId:"item_chapter_1"}),x;for(let s=0;s<B.length;s++){const E=B[s],C=E.title,ne=E.index+E.rawMatch.length,j=s+1<B.length?B[s+1].index:h.length,G=h.substring(ne,j).trim(),$=s+1;x.push({title:C,content:G,xhtmlFileName:`chapter_${$}.xhtml`,ncxNavPointId:`navpoint_${$}`,opfItemId:`item_chapter_${$}`})}return x}async function Be(e,t){const n=new JSZip;return e.forEach(i=>{const a=`${re(i.title,100)}.txt`;n.file(a,`${i.title}

${i.content}`)}),n.generateAsync({type:"blob"})}async function De(e,t){const n=new JSZip,i=xe(),a=Y(t),o="OEBPS/";n.file("mimetype","application/epub+zip",{compression:"STORE"});const p=`<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="${o}content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`;n.file("META-INF/container.xml",p),n.file(`${o}style.css`,`body { font-family: sans-serif; margin: 5%; line-height: 1.4; }
h1 { text-align: center; margin-bottom: 1em; font-size: 1.5em; }
p { margin-bottom: 0.8em; text-indent: 1.5em; }`);let k=`<item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
`;k+=`    <item id="css" href="style.css" media-type="text/css"/>
`;let M="";e.forEach(d=>{k+=`    <item id="${d.opfItemId}" href="${d.xhtmlFileName}" media-type="application/xhtml+xml"/>
`,M+=`    <itemref idref="${d.opfItemId}"/>
`});const J=`<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="bookid" version="2.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
    <dc:title>${a}</dc:title>
    <dc:language>en</dc:language> 
    <dc:identifier id="bookid">urn:uuid:${i}</dc:identifier>
    <meta name="generator" content="EPUB Chapter Splitter" />
  </metadata>
  <manifest>
${k}  </manifest>
  <spine toc="ncx">
${M}  </spine>
</package>`;n.file(`${o}content.opf`,J);let L="";e.forEach((d,x)=>{const F=Y(d.title);L+=`    <navPoint id="${d.ncxNavPointId}" playOrder="${x+1}">
      <navLabel><text>${F}</text></navLabel>
      <content src="${d.xhtmlFileName}"/>
    </navPoint>
`});const h=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ncx PUBLIC "-//NISO//DTD ncx 2005-1//EN" "http://www.daisy.org/z3986/2005/ncx-2005-1.dtd">
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head>
    <meta name="dtb:uid" content="urn:uuid:${i}"/>
    <meta name="dtb:depth" content="1"/>
    <meta name="dtb:totalPageCount" content="0"/>
    <meta name="dtb:maxPageNumber" content="0"/>
  </head>
  <docTitle><text>${a}</text></docTitle>
  <navMap>
${L}  </navMap>
</ncx>`;return n.file(`${o}toc.ncx`,h),e.forEach(d=>{const x=Y(d.title),N=d.content.split(/\n\s*\n/).map(D=>D.trim()).filter(D=>D.length>0).map(D=>`<p>${Y(D).replace(/\n/g,`<br/>
`)}</p>`).join(`
  `),B=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>${x}</title>
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
  <h1>${x}</h1>
  ${N}
</body>
</html>`;n.file(`${o}${d.xhtmlFileName}`,B)}),n.generateAsync({type:"blob"})}function Se(e){const t=e.target;t.files&&t.files.length>0?(A=t.files[0],P&&(P.textContent=A.name),b&&(b.disabled=!1),_=A.name.substring(0,A.name.lastIndexOf("."))||"document",f&&(f.style.display="none"),c("Please select an EPUB file and verify advanced options if needed.","info")):(A=null,P&&(P.textContent="No file chosen"),b&&(b.disabled=!0))}async function Ne(){if(!A){c("Please select an EPUB file first.","error");return}Q(!0),T=[];try{if(T=await Ie(A),T.length>0){let e=`Successfully split the EPUB into ${T.length} chapter(s). Ready to download.`;T.length===1&&T[0].title==="Full Document (No Chapter Markers Detected)"&&(e="No chapter markers found using the current regex pattern. The EPUB content is treated as a single document. Ensure chapter titles are on their own lines and match the selected regex pattern in Advanced Options."),c(e,"success"),f&&(f.style.display="flex")}else c("No chapters were extracted from the EPUB.","info")}catch(e){console.error("Error processing EPUB:",e),c(`Error: ${e.message}`,"error"),f&&(f.style.display="none")}finally{Q(!1)}}async function de(e){if(T.length===0){c("No content processed. Please process an EPUB file first.","error");return}Q(!0);let t=e==="txt"?"TXT ZIP":"EPUB";c(`Generating ${t}...`,"processing");try{let n,i;e==="txt"?(n=await Be(T,_),i=`${re(_,50)}_Chapters_TXT.zip`):(n=await De(T,_),i=`${re(_,50)}_AllChapters.epub`);const a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=i,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a),c(`${t} generated and download started.`,"success")}catch(n){console.error(`Error generating ${t}:`,n),c(`Error generating ${t}: ${n.message}`,"error")}finally{Q(!1)}}function z(e){e==="dark"?(document.body.classList.add("dark-mode"),w&&w.setAttribute("aria-label","Switch to light theme")):(document.body.classList.remove("dark-mode"),w&&w.setAttribute("aria-label","Switch to dark theme"))}function Ce(){document.body.classList.contains("dark-mode")?(z("light"),localStorage.setItem("theme","light")):(z("dark"),localStorage.setItem("theme","dark"))}function Ae(){const e=localStorage.getItem("theme"),t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;z(e||(t?"dark":"light"))}document.addEventListener("DOMContentLoaded",()=>{if(O=document.getElementById("epubFile"),P=document.getElementById("fileName"),b=document.getElementById("splitButton"),y=document.getElementById("statusArea"),f=document.getElementById("downloadButtonsContainer"),ae=document.getElementById("downloadTxtZipButton"),oe=document.getElementById("downloadEpubZipButton"),K=document.getElementById("appContainer"),w=document.getElementById("themeToggleButton"),r=document.getElementById("regexTemplateSelect"),W=document.getElementById("currentPatternDisplay"),v=document.getElementById("showAddTemplateFormButton"),U=document.getElementById("resetToDefaultTemplateButton"),I=document.getElementById("addTemplateFormContainer"),m=document.getElementById("newTemplateNameInput"),u=document.getElementById("newTemplatePatternInput"),R=document.getElementById("saveTemplateButton"),X=document.getElementById("cancelAddTemplateButton"),g=document.getElementById("advancedOptionsToggle"),S=document.getElementById("advancedOptionsContent"),!O||!b||!y||!f||!ae||!oe||!P||!K||!w||!r||!W||!v||!U||!I||!m||!u||!R||!X||!g||!S){console.error("Initialization failed: One or more essential DOM elements are missing."),alert("Error initializing the application. Some UI elements could not be found. Check console for details.");return}O.addEventListener("change",Se),b.addEventListener("click",Ne),ae.addEventListener("click",()=>de("txt")),oe.addEventListener("click",()=>de("epub")),w.addEventListener("click",Ce),g.addEventListener("click",ge),r.addEventListener("change",H),v.addEventListener("click",be),U.addEventListener("click",ve),R.addEventListener("click",we),X.addEventListener("click",se),Ae(),ye(),ue(),c("Please select an EPUB file to begin, or manage regex templates in Advanced Options.","info")});typeof JSZip>"u"&&console.warn("JSZip not available yet. Ensure it's loaded before app interactions.");
