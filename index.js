var F,N,y,x,u,ee,te,W,b,r,q,B,_,L,d,f,R,U,g,k,w=null,T=[],P="document",re="^\\s*(\u7B2C\\s*\\d+\\s*\u7AE0[^\\r\\n]*?)\\s*$",ne="Default (\u7B2CX\u7AE0)",oe="^\\s*(\u7B2C\\s*[\u4E00\u4E8C\u4E09\u56DB\u4E94\u516D\u4E03\u516B\u4E5D\u5341\u767E\u5343\u4E07]+\\s*\u7AE0[^\\r\\n]*?)\\s*$",ae="Default (Chinese Numerals \u7B2CX\u7AE0)",a=[],O=re,ce="epubSplitterRegexTemplates",Y="epubSplitterSelectedTemplateName";function fe(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function le(e,t=60){let n=e.replace(/[<>:"/\\|?*\x00-\x1F]/g,"_");return n=n.replace(/[\s_]+/g,"_"),n=n.replace(/^_+|_+$/g,""),n=n||"chapter",n.substring(0,t)}function G(e){return e.replace(/[<>&'""]/g,function(t){switch(t){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case'"':return"&quot;"}return t})}function c(e,t="info"){x&&(x.textContent=e,x.className="",t&&x.classList.add(t),e?(x.style.display="block",x.setAttribute("aria-live",t==="error"?"assertive":"polite")):x.style.display="none")}function K(e){W&&W.setAttribute("aria-busy",String(e)),y&&(y.disabled=e),F&&(F.disabled=e),b&&(b.disabled=e),g&&(g.disabled=e);let t=k?.classList.contains("open");r&&(r.disabled=e&&t),B&&(B.disabled=e&&t),_&&(_.disabled=e&&t),L&&L.style.display!=="none"&&(d&&(d.disabled=e),f&&(f.disabled=e),R&&(R.disabled=e),U&&(U.disabled=e)),e&&(c("Processing EPUB... This may take a moment.","processing"),u&&(u.style.display="none"))}function ge(e,t){let o=(e.includes("/")?e.substring(0,e.lastIndexOf("/")+1):"").split("/").filter(s=>s.length>0),l=t.split("/");for(let s of l)s===".."?o.length>0&&o.pop():s!=="."&&s!==""&&o.push(s);return o.join("/")}function he(){let e=localStorage.getItem(ce);if(e)try{a=JSON.parse(e)}catch(l){console.error("Error parsing stored regex templates:",l),a=[]}else a=[];let t=!1;if(a.some(l=>l.name===ne&&l.isDefault)||(a=a.filter(l=>l.name!==ne),a.unshift({name:ne,pattern:re,isDefault:!0}),t=!0),!a.some(l=>l.name===ae)){let l=a.findIndex(s=>s.isDefault);l!==-1&&l<a.length-1?a.splice(l+1,0,{name:ae,pattern:oe,isDefault:!1}):a.push({name:ae,pattern:oe,isDefault:!1}),t=!0}t&&me()}function me(){localStorage.setItem(ce,JSON.stringify(a))}function de(){if(!r)return;r.innerHTML="",a.forEach(n=>{let o=document.createElement("option");o.value=n.name,o.textContent=n.name,n.isDefault,r.appendChild(o)});let e=localStorage.getItem(Y),t=a.find(n=>n.name===e)||a.find(n=>n.isDefault);t?r.value=t.name:a.length>0&&(r.value=a[0].name),Z()}function Ee(){q&&(q.textContent=O)}function Z(){if(!r)return;let e=r.value,t=a.find(n=>n.name===e);if(t)O=t.pattern,localStorage.setItem(Y,t.name);else{let n=a.find(o=>o.isDefault);n?(O=n.pattern,localStorage.setItem(Y,n.name),r&&(r.value=n.name)):a.length>0&&(O=a[0].pattern,localStorage.setItem(Y,a[0].name),r&&(r.value=a[0].name))}Ee()}function xe(){L&&d&&f&&(d.value="",f.value="",L.style.display="block",d.focus(),B&&(B.style.display="none"),g&&k&&g.getAttribute("aria-expanded")==="false"&&pe())}function ie(){L&&(L.style.display="none",B&&(B.style.display="inline-block"))}function Te(){if(!d||!f)return;let e=d.value.trim(),t=f.value.trim();if(!e){c("Template name cannot be empty.","error"),d.focus();return}if(!t){c("Template pattern cannot be empty.","error"),f.focus();return}if(a.some(n=>n.name===e)){c(`A template with the name "${e}" already exists.`,"error"),d.focus();return}try{new RegExp(t)}catch(n){c(`Invalid regex pattern: ${n.message}`,"error"),f.focus();return}a.push({name:e,pattern:t,isDefault:!1}),me(),de(),r.value=e,Z(),ie(),c(`Template "${e}" saved successfully.`,"success")}function ye(){let e=a.find(t=>t.isDefault);e&&r?(r.value=e.name,Z(),c("Regex pattern reset to default.","info")):a.length>0&&r&&(r.value=a[0].name,Z(),c("Regex pattern reset to the first available template.","info"))}function pe(){if(!g||!k)return;let e=g.getAttribute("aria-expanded")==="true";g.setAttribute("aria-expanded",String(!e)),k.classList.toggle("open",!e),e&&L.style.display==="block"&&ie()}async function be(e){let t=await JSZip.loadAsync(e),n=t.file("META-INF/container.xml");if(!n)throw new Error("META-INF/container.xml not found in EPUB.");let o=await n.async("string"),l=new DOMParser,C=l.parseFromString(o,"application/xml").getElementsByTagName("rootfile")[0]?.getAttribute("full-path");if(!C)throw new Error("Could not find rootfile path in container.xml.");let Q=t.file(C);if(!Q)throw new Error(`.opf file (${C}) not found.`);let H=await Q.async("string"),A=l.parseFromString(H,"application/xml"),z=new Map,S=A.getElementsByTagName("item");for(let i=0;i<S.length;i++){let p=S[i].getAttribute("id"),M=S[i].getAttribute("href");p&&M&&z.set(p,M)}let h="",m=A.getElementsByTagName("itemref");for(let i=0;i<m.length;i++){let p=m[i].getAttribute("idref");if(p){let M=z.get(p);if(M){let V=ge(C,M),J=t.file(V);if(J){let j=await J.async("string"),D=l.parseFromString(j,"application/xhtml+xml");if(D.getElementsByTagName("parsererror").length>0){let ue=l.parseFromString(j,"text/html");h+=ue.body?.textContent||""}else h+=D.body?.textContent||"";h+=`

`}}}}let E=[],$;try{$=new RegExp(O,"gm")}catch(i){throw new Error(`Invalid Regex Pattern in selected template: ${i.message}. Please check Advanced Options.`)}let v,I=[];for(;(v=$.exec(h))!==null;){let i=(v[1]||v[0]).trim();I.push({title:i,index:v.index,rawMatch:v[0]})}if(I.length===0)return E.push({title:"Full Document (No Chapter Markers Detected)",content:h.trim(),xhtmlFileName:"chapter_1.xhtml",ncxNavPointId:"navpoint_1",opfItemId:"item_chapter_1"}),E;for(let i=0;i<I.length;i++){let p=I[i],M=p.title,V=p.index+p.rawMatch.length,J=i+1<I.length?I[i+1].index:h.length,j=h.substring(V,J).trim(),D=i+1;E.push({title:M,content:j,xhtmlFileName:`chapter_${D}.xhtml`,ncxNavPointId:`navpoint_${D}`,opfItemId:`item_chapter_${D}`})}return E}async function Be(e,t){let n=new JSZip;return e.forEach(o=>{let l=`${le(o.title,100)}.txt`;n.file(l,`${o.title}

${o.content}`)}),n.generateAsync({type:"blob"})}async function Le(e,t){let n=new JSZip,o=fe(),l=G(t),s="OEBPS/";n.file("mimetype","application/epub+zip",{compression:"STORE"});let C=`<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="${s}content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`;n.file("META-INF/container.xml",C),n.file(`${s}style.css`,`body { font-family: sans-serif; margin: 5%; line-height: 1.4; }
h1 { text-align: center; margin-bottom: 1em; font-size: 1.5em; }
p { margin-bottom: 0.8em; text-indent: 1.5em; }`);let H=`<item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
`;H+=`    <item id="css" href="style.css" media-type="text/css"/>
`;let A="";e.forEach(m=>{H+=`    <item id="${m.opfItemId}" href="${m.xhtmlFileName}" media-type="application/xhtml+xml"/>
`,A+=`    <itemref idref="${m.opfItemId}"/>
`});let z=`<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="bookid" version="2.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
    <dc:title>${l}</dc:title>
    <dc:language>en</dc:language> 
    <dc:identifier id="bookid">urn:uuid:${o}</dc:identifier>
    <meta name="generator" content="EPUB Chapter Splitter" />
  </metadata>
  <manifest>
${H}  </manifest>
  <spine toc="ncx">
${A}  </spine>
</package>`;n.file(`${s}content.opf`,z);let S="";e.forEach((m,E)=>{let $=G(m.title);S+=`    <navPoint id="${m.ncxNavPointId}" playOrder="${E+1}">
      <navLabel><text>${$}</text></navLabel>
      <content src="${m.xhtmlFileName}"/>
    </navPoint>
`});let h=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ncx PUBLIC "-//NISO//DTD ncx 2005-1//EN" "http://www.daisy.org/z3986/2005/ncx-2005-1.dtd">
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head>
    <meta name="dtb:uid" content="urn:uuid:${o}"/>
    <meta name="dtb:depth" content="1"/>
    <meta name="dtb:totalPageCount" content="0"/>
    <meta name="dtb:maxPageNumber" content="0"/>
  </head>
  <docTitle><text>${l}</text></docTitle>
  <navMap>
${S}  </navMap>
</ncx>`;return n.file(`${s}toc.ncx`,h),e.forEach(m=>{let E=G(m.title),v=m.content.split(/\n\s*\n/).map(i=>i.trim()).filter(i=>i.length>0).map(i=>`<p>${G(i).replace(/\n/g,`<br/>
`)}</p>`).join(`
  `),I=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>${E}</title>
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
  <h1>${E}</h1>
  ${v}
</body>
</html>`;n.file(`${s}${m.xhtmlFileName}`,I)}),n.generateAsync({type:"blob"})}function Ie(e){let t=e.target;t.files&&t.files.length>0?(w=t.files[0],N&&(N.textContent=w.name),y&&(y.disabled=!1),P=w.name.substring(0,w.name.lastIndexOf("."))||"document",u&&(u.style.display="none"),c("Please select an EPUB file and verify advanced options if needed.","info")):(w=null,N&&(N.textContent="No file chosen"),y&&(y.disabled=!0))}async function Me(){if(!w){c("Please select an EPUB file first.","error");return}K(!0),T=[];try{if(T=await be(w),T.length>0){let e=`Successfully split the EPUB into ${T.length} chapter(s). Ready to download.`;T.length===1&&T[0].title==="Full Document (No Chapter Markers Detected)"&&(e="No chapter markers found using the current regex pattern. The EPUB content is treated as a single document. Ensure chapter titles are on their own lines and match the selected regex pattern in Advanced Options."),c(e,"success"),u&&(u.style.display="flex")}else c("No chapters were extracted from the EPUB.","info")}catch(e){console.error("Error processing EPUB:",e),c(`Error: ${e.message}`,"error"),u&&(u.style.display="none")}finally{K(!1)}}async function se(e){if(T.length===0){c("No content processed. Please process an EPUB file first.","error");return}K(!0);let t=e==="txt"?"TXT ZIP":"EPUB";c(`Generating ${t}...`,"processing");try{let n,o;e==="txt"?(n=await Be(T,P),o=`${le(P,50)}_Chapters_TXT.zip`):(n=await Le(T,P),o=`${le(P,50)}_AllChapters.epub`);let l=URL.createObjectURL(n),s=document.createElement("a");s.href=l,s.download=o,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(l),c(`${t} generated and download started.`,"success")}catch(n){console.error(`Error generating ${t}:`,n),c(`Error generating ${t}: ${n.message}`,"error")}finally{K(!1)}}function X(e){e==="dark"?(document.body.classList.add("dark-mode"),b&&b.setAttribute("aria-label","Switch to light theme")):(document.body.classList.remove("dark-mode"),b&&b.setAttribute("aria-label","Switch to dark theme"))}function ve(){document.body.classList.contains("dark-mode")?(X("light"),localStorage.setItem("theme","light")):(X("dark"),localStorage.setItem("theme","dark"))}function we(){let e=localStorage.getItem("theme"),t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;X(e||(t?"dark":"light"))}document.addEventListener("DOMContentLoaded",()=>{if(F=document.getElementById("epubFile"),N=document.getElementById("fileName"),y=document.getElementById("splitButton"),x=document.getElementById("statusArea"),u=document.getElementById("downloadButtonsContainer"),ee=document.getElementById("downloadTxtZipButton"),te=document.getElementById("downloadEpubZipButton"),W=document.getElementById("appContainer"),b=document.getElementById("themeToggleButton"),r=document.getElementById("regexTemplateSelect"),q=document.getElementById("currentPatternDisplay"),B=document.getElementById("showAddTemplateFormButton"),_=document.getElementById("resetToDefaultTemplateButton"),L=document.getElementById("addTemplateFormContainer"),d=document.getElementById("newTemplateNameInput"),f=document.getElementById("newTemplatePatternInput"),R=document.getElementById("saveTemplateButton"),U=document.getElementById("cancelAddTemplateButton"),g=document.getElementById("advancedOptionsToggle"),k=document.getElementById("advancedOptionsContent"),!F||!y||!x||!u||!ee||!te||!N||!W||!b||!r||!q||!B||!_||!L||!d||!f||!R||!U||!g||!k){console.error("Initialization failed: One or more essential DOM elements are missing."),alert("Error initializing the application. Some UI elements could not be found. Check console for details.");return}F.addEventListener("change",Ie),y.addEventListener("click",Me),ee.addEventListener("click",()=>se("txt")),te.addEventListener("click",()=>se("epub")),b.addEventListener("click",ve),g.addEventListener("click",pe),r.addEventListener("change",Z),B.addEventListener("click",xe),_.addEventListener("click",ye),R.addEventListener("click",Te),U.addEventListener("click",ie),we(),he(),de(),c("Please select an EPUB file to begin, or manage regex templates in Advanced Options.","info")});typeof JSZip>"u"&&console.warn("JSZip not available yet. Ensure it's loaded before app interactions.");
